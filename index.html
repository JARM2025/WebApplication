<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weather Station</title>

  <!-- Inter to match Grafana -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f19; --fg:#e6e9ef; --card:#111727; --border:rgba(255,255,255,.12);
      --header-h:64px;
      --gap:12px;
      /* default box heights (Details) */
      --box-h:70vh;        /* card/box body height */
      --frame-h:calc(var(--box-h) - 36px); /* minus header */
      /* Tabs (dark) */
      --tab-bg: rgba(255,255,255,.02);
      --tab-hover-border: rgba(255,255,255,.35);
      --tab-selected-bg: rgba(255,255,255,.16);
      --tab-selected-border: rgba(255,255,255,.55);
      --tab-selected-fg: var(--fg);
    }
    body.light{
      --bg:#f7f8fb; --fg:#0b0f1d; --card:#ffffff; --border:rgba(0,0,0,.15);
      /* Tabs (light): stronger visual distinction */
      --tab-bg: rgba(0,0,0,.05);
      --tab-hover-border: rgba(0,0,0,.45);
      --tab-selected-bg: #e8edf6;                 /* noticeable pill */
      --tab-selected-border: rgba(0,0,0,.55);     /* darker border */
      --tab-selected-fg: #0b0f1d;                 /* dark text */
    }

    *{ box-sizing:border-box }
    html, body { height:100%; }
    html{ scroll-padding-top: var(--header-h); } /* avoid sticky header covering anchors */
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Header + tabs */
    header{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      padding:12px 16px; background:var(--card); border-bottom:1px solid var(--border);
      box-shadow:0 2px 6px rgba(0,0,0,.2);
    }
    header h1{ margin:0; font-size:18px; font-weight:700; }
    .spacer{ flex:1 1 auto }

    .tabs{
      display:inline-flex; gap:6px; padding:4px;
      border:1px solid var(--border);
      border-radius:12px; background:var(--tab-bg);
      align-items:center;
    }
    .tab{
      appearance:none; border:1px solid var(--border); background:transparent; color:var(--fg);
      padding:6px 12px; border-radius:10px; font:600 13px "Inter",system-ui,sans-serif; cursor:pointer;
      transition: border-color .15s ease, background .15s ease, color .15s ease;
    }
    .tab:hover{ border-color: var(--tab-hover-border); }
    .tab[aria-selected="true"]{
      background: var(--tab-selected-bg);
      border-color: var(--tab-selected-border);
      color: var(--tab-selected-fg);
    }
    .tab:focus-visible{
      outline: 2px solid currentColor;
      outline-offset: 2px;
    }

    .theme-btn{
      appearance:none; border:1px solid var(--border); background:transparent; color:var(--fg);
      border-radius:10px; padding:6px 12px; font:600 13px "Inter",system-ui,sans-serif; cursor:pointer;
      height:32px; transition: border-color .15s ease;
    }
    .theme-btn:hover{ border-color:rgba(100,100,100,.4) }

    .wrap{ width:100%; padding:8px 0; }

    /* Details (collapsible sections) */
    .sectionbar{
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:8px;
      padding:12px 12px 8px; border-bottom:1px solid var(--border); background:var(--card); margin-bottom:4px;
      cursor:pointer; user-select:none; transition: background .15s ease, color .15s ease;
    }
    .sectionbar:hover{ background:rgba(255,255,255,.04); }
    .sectionbar:focus-visible{
      outline:2px solid currentColor;
      outline-offset:2px;
    }
    .sectionbar h2{ margin:0; font:700 18px "Inter",system-ui,sans-serif; text-align:center; position:relative; }
    .sectionbar h2::after{ content:"â–¾"; font-size:14px; margin-left:10px; opacity:.6; }
    .sectionbar[aria-expanded="false"] h2::after{ content:"â–¸"; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; padding:0 12px; }
    .col{ flex:1; min-width:300px; }

    .box{
      margin:12px 0; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--card);
      height:var(--box-h); box-shadow:0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.3);
    }
    .box-head{
      display:flex; align-items:center; justify-content:space-between;
      height:36px; padding:6px 10px; border-bottom:1px solid var(--border); background:rgba(0,0,0,.08);
    }
    .box-head .title{ font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .fs-btn{
      display:inline-grid; place-items:center;
      width:34px; height:32px; padding:0;
      border:1px solid var(--border); background:rgba(255,255,255,.06); color:var(--fg);
      border-radius:10px; font:600 12px "Inter",system-ui,sans-serif; cursor:pointer;
      line-height:1; -webkit-tap-highlight-color: transparent; touch-action: manipulation;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .fs-btn:hover{ border-color: var(--tab-hover-border); background: rgba(255,255,255,.10) }
    .fs-btn:active{ transform: translateY(1px); }
    body.light .fs-btn{ background: rgba(0,0,0,.06); }
    .fs-btn:focus-visible{
      outline:2px solid currentColor;
      outline-offset:2px;
    }
    .frame{ height:var(--frame-h); position:relative; }
    iframe{ width:100%; height:100%; border:0; display:block; }

    .box:fullscreen{ border:none; border-radius:0; height:100dvh; background:var(--card); }
    .box:fullscreen .box-head{ display:none; }
    .box:fullscreen .frame{ height:100dvh; }

    /* Summary: full-window grid */
    .summary-wrap{
      height: calc(100dvh - var(--header-h)); /* fill viewport minus header */
      padding: 8px 12px;
    }
    .summary-grid{
      display:grid; gap:var(--gap); height:100%;
      grid-template-columns: 1fr 1fr;        /* 2 columns default */
      grid-template-rows: 1fr 1fr;           /* 2 rows default */
    }
    .card{
      border:1px solid var(--border); background:var(--card); border-radius:14px;
      box-shadow:0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.3);
      overflow:hidden; display:flex; flex-direction:column; min-height:0;
    }
    .card-head{
      padding:8px 10px; font-weight:600; border-bottom:1px solid var(--border); opacity:.9; font-size:13px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .card-body{ flex:1; min-height:0; }
    .card-body iframe{ width:100%; height:100%; display:block; }

    /* Fullscreen behavior for cards (mirror .box) */
    .card:fullscreen{ border:none; border-radius:0; height:100dvh; background:var(--card); }
    .card:fullscreen .card-head{ display:none; }
    .card:fullscreen .card-body{ height:100dvh; }
    .card:fullscreen .card-body iframe{ height:100dvh; }

    /* Fallback overlay for iframes (simple error message only) */
    .iframe-fallback{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(0deg, rgba(0,0,0,.45), rgba(0,0,0,.45));
      color:#fff; padding:16px; text-align:center;
    }
    .iframe-fallback .msg{
      font:600 14px "Inter",system-ui,sans-serif; opacity:.95;
    }

    /* Tab panels visibility */
    [role="tabpanel"]{ display:none; }
    [role="tabpanel"][data-active="true"]{ display:block; }

    /* ===================== RESPONSIVE ===================== */
    /* Laptops/medium: let rows auto-size, keep 2 columns */
    @media (max-width: 1100px){
      .summary-grid{
        grid-template-rows: unset;
        grid-auto-rows: minmax(260px, 1fr);
      }
      :root{ --box-h: 62vh; --frame-h: calc(var(--box-h) - 36px); }
    }

    /* Tablets: still two columns, shorter boxes */
    @media (max-width: 900px){
      :root{ --box-h: 56vh; --frame-h: calc(var(--box-h) - 36px); }
    }

    /* Phones: single column Summary, shorter boxes in Details */
    @media (max-width: 700px){
      .summary-grid{ grid-template-columns: 1fr; grid-auto-rows: minmax(220px, 42dvh); }
      .card{ min-height: 0; }
      :root{ --box-h: 52vh; --frame-h: calc(var(--box-h) - 36px); }
    }

    /* Very small phones */
    @media (max-width: 480px){
      :root{ --box-h: 46vh; --frame-h: calc(var(--box-h) - 36px); --gap: 10px; }
      header h1{ font-size:16px; }
      .tab{ padding:5px 10px; font-size:12px; }
    }

    /* ===== Exit Fullscreen overlay (LEFT) ===== */
    .fs-exit{
      position:fixed; top:14px; left:14px; z-index:1000;
      background: rgba(17,24,39,.85); color:#fff;
      border:1px solid rgba(255,255,255,.22);
      padding:8px 12px; border-radius:10px; font:600 13px "Inter",system-ui,sans-serif;
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
      cursor:pointer;
    }
    .fs-exit:hover{ filter: brightness(1.05); }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      * { animation: none !important; transition: none !important; }
    }
  
    .fs-btn svg{ width:18px; height:18px; display:block; }
    @media (max-width: 700px){
      .fs-btn{ width:40px; height:36px; border-radius:12px; }
      .fs-btn svg{ width:20px; height:20px; }
    }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,1px,1px); white-space:nowrap; border:0; }

  </style>
</head>
<body>
  <header>
    <h1>Weather Station</h1>
    <div class="spacer"></div>

    <!-- Tabs: Summary first, Details second -->
    <div class="tabs" role="tablist" aria-label="Views" aria-orientation="horizontal" id="tablist">
      <button class="tab" role="tab" id="tab-summary" aria-controls="panel-summary" aria-selected="true">Summary</button>
      <button class="tab" role="tab" id="tab-details" aria-controls="panel-details" aria-selected="false">Details</button>
    </div>

    <button id="themeToggle" class="theme-btn">ðŸŒ™ Dark Mode</button>
  </header>

  <main>
    <!-- ================= Details panel ================= -->
    <section id="panel-details" role="tabpanel" aria-labelledby="tab-details" data-active="false" class="wrap">
      <!-- F Index -->
      <div class="sectionbar" data-target="sec-findex" aria-controls="sec-findex" aria-expanded="true" title="Click to show/hide">
        <div></div><h2>F Index</h2><div></div>
      </div>
      <div id="sec-findex" class="row">
        <div class="col">
          <div class="box">
            <div class="box-head">
              <span class="title">F Index â€” Last Value</span>
              <button class="fs-btn" title="Fullscreen">â¤¢</button>
            </div>
            <div class="frame">
              <iframe title="F Index â€” Last Value" src="https://grafana.weatherstation.site/d/aexavp9st0d8gf/f-index-values?orgId=2&theme=dark&from=now-5m&to=now&timezone=browser&refresh=5s&viewPanel=1" allowfullscreen></iframe>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="box">
            <div class="box-head">
              <span class="title">F Index â€” Historical Data</span>
              <button class="fs-btn" title="Fullscreen">â¤¢</button>
            </div>
            <div class="frame">
              <iframe title="F Index â€” Historical Data" src="https://grafana.weatherstation.site/d/eexavbf1ivqwwb/f-index-data?orgId=2&theme=dark&from=now-5m&to=now%2B5m&timezone=browser&refresh=5s&viewPanel=1" allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </div>

      <!-- Sensor 1 (DHT22) -->
      <div class="sectionbar" data-target="sec-s1" aria-controls="sec-s1" aria-expanded="true" title="Click to show/hide">
        <div></div><h2>Sensor 1 (DHT22)</h2><div></div>
      </div>
      <div id="sec-s1" class="row">
        <div class="col">
          <div class="box">
            <div class="box-head">
              <span class="title">Sensor 1 â€” Last Value</span>
              <button class="fs-btn" title="Fullscreen">â¤¢</button>
            </div>
            <div class="frame">
              <iframe title="Sensor 1 â€” Last Value" src="https://grafana.weatherstation.site/d/cewx3uhpyrsowa/dht22-1-values?orgId=2&theme=dark&from=now-5m&to=now&timezone=browser&refresh=5s&viewPanel=1" allowfullscreen></iframe>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="box">
            <div class="box-head">
              <span class="title">Sensor 1 â€” Historical Data</span>
              <button class="fs-btn" title="Fullscreen">â¤¢</button>
            </div>
            <div class="frame">
              <iframe title="Sensor 1 â€” Historical Data" src="https://grafana.weatherstation.site/d/aewvz2fwevpc0c/dht22-1-data?orgId=2&theme=dark&from=now-5m&to=now%2B5m&timezone=browser&refresh=5s&viewPanel=1" allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </div>

      <!-- Sensor 2 (Anemometer) -->
      <div class="sectionbar" data-target="sec-s2" aria-controls="sec-s2" aria-expanded="true" title="Click to show/hide">
        <div></div><h2>Sensor 2 (Anemometer)</h2><div></div>
      </div>
      <div id="sec-s2" class="row">
        <div class="col">
          <div class="box">
            <div class="box-head">
              <span class="title">Sensor 2 â€” Last Value</span>
              <button class="fs-btn" title="Fullscreen">â¤¢</button>
            </div>
            <div class="frame">
              <iframe title="Sensor 2 â€” Last Value" src="https://grafana.weatherstation.site/d/dexaqaus59w5ca/anemometer-values?orgId=2&theme=dark&from=now-5m&to=now&timezone=browser&refresh=5s&viewPanel=1" allowfullscreen></iframe>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="box">
            <div class="box-head">
              <span class="title">Sensor 2 â€” Historical Data</span>
              <button class="fs-btn" title="Fullscreen">â¤¢</button>
            </div>
            <div class="frame">
              <iframe title="Sensor 2 â€” Historical Data" src="https://grafana.weatherstation.site/d/dexan9rr3s3k0b/anemometer-data?orgId=2&theme=dark&from=now-5m&to=now%2B5m&timezone=browser&refresh=5s&viewPanel=1" allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ================= Summary panel (default) ================= -->
    <section id="panel-summary" role="tabpanel" aria-labelledby="tab-summary" data-active="true">
      <div class="summary-wrap">
        <div class="summary-grid">
          <section class="card">
            <div class="card-head">
              <span>F Index</span>
              <button class="fs-btn" title="Fullscreen">â¤¢</button>
            </div>
            <div class="card-body">
              <iframe title="F Index" src="https://grafana.weatherstation.site/d/aexeli5nf9uyoe/f-index?orgId=2&theme=dark&from=now-5m&to=now&timezone=browser&refresh=5s&viewPanel=panel-1" allowfullscreen></iframe>
            </div>
          </section>

          <section class="card">
            <div class="card-head">
              <span>Temperature</span>
              <button class="fs-btn" title="Fullscreen">â¤¢</button>
            </div>
            <div class="card-body">
              <iframe title="Temperature" src="https://grafana.weatherstation.site/d/dexdt525kcf7kc/temperature?orgId=2&theme=dark&from=now-5m&to=now&timezone=browser&refresh=5s&viewPanel=1" allowfullscreen></iframe>
            </div>
          </section>

          <section class="card">
            <div class="card-head">
              <span>Humidity</span>
              <button class="fs-btn" title="Fullscreen">â¤¢</button>
            </div>
            <div class="card-body">
              <iframe title="Humidity" src="https://grafana.weatherstation.site/d/cexesd7aohzwgf/humidity?orgId=2&theme=dark&from=now-5m&to=now&timezone=browser&refresh=5s&viewPanel=panel-1" allowfullscreen></iframe>
            </div>
          </section>

          <section class="card">
            <div class="card-head">
              <span>Wind Speed</span>
              <button class="fs-btn" title="Fullscreen">â¤¢</button>
            </div>
            <div class="card-body">
              <iframe title="Wind Speed" src="https://grafana.weatherstation.site/d/bexev0z3n203kc/wind-speed?orgId=2&from=now-5m&to=now&timezone=browser&refresh=5s&viewPanel=panel-1&kiosk=tv" allowfullscreen></iframe>
            </div>
          </section>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Measure header for full-height summary
    function setHeaderHeight(){
      const h = document.querySelector('header')?.offsetHeight || 64;
      document.documentElement.style.setProperty('--header-h', h + 'px');
    }
    window.addEventListener('load', setHeaderHeight);
    window.addEventListener('resize', setHeaderHeight);

    // Tabs
    const tabs = [...document.querySelectorAll('.tab')];
    const panels = {
      'tab-details': document.getElementById('panel-details'),
      'tab-summary': document.getElementById('panel-summary'),
    };
    function activateTab(tabId, pushHash=true){
      tabs.forEach(t=>{
        const selected = (t.id === tabId);
        t.setAttribute('aria-selected', selected ? 'true' : 'false');
        // Keep focus in sync with selection
        if (selected) t.focus({preventScroll:true});
      });
      Object.entries(panels).forEach(([id, panel])=>{
        panel.dataset.active = (id === tabId) ? 'true' : 'false';
      });
      if (pushHash) location.hash = (tabId === 'tab-summary') ? '#summary' : '#details';
      setHeaderHeight();
    }
    // Mouse/Touch activation
    document.addEventListener('click', (e)=>{
      const t = e.target.closest('.tab');
      if (t) activateTab(t.id);
    });
    // Hash routing
    window.addEventListener('hashchange', ()=>{
      const h = location.hash.toLowerCase();
      if (h.includes('detail')) activateTab('tab-details', false);
      else if (h.includes('summary')) activateTab('tab-summary', false);
    });
    (function initTabs(){
      const h = location.hash.toLowerCase();
      if (h.includes('detail')) activateTab('tab-details', false);
      else activateTab('tab-summary'); // default: Summary
    })();
    // Keyboard navigation for tabs (ArrowLeft/ArrowRight/Home/End)
    const tablist = document.getElementById('tablist');
    function moveFocus(idxDelta){
      const i = tabs.findIndex(t => t.getAttribute('aria-selected') === 'true');
      let j = i + idxDelta;
      if (j < 0) j = tabs.length - 1;
      if (j >= tabs.length) j = 0;
      activateTab(tabs[j].id);
    }
    tablist?.addEventListener('keydown', (e)=>{
      switch(e.key){
        case 'ArrowLeft': e.preventDefault(); moveFocus(-1); break;
        case 'ArrowRight': e.preventDefault(); moveFocus(1); break;
        case 'Home': e.preventDefault(); activateTab(tabs[0].id); break;
        case 'End': e.preventDefault(); activateTab(tabs[tabs.length-1].id); break;
      }
    });

    // Collapsible sections (Details) with accessibility + persistence
    function storageKeyFor(targetId){ return `ws_collapsed_${targetId}`; }
    function restoreSectionState(){
      document.querySelectorAll('.sectionbar').forEach(bar=>{
        // Make focusable and operable by keyboard
        bar.setAttribute('role','button');
        bar.setAttribute('tabindex','0');

        const targetId = bar.dataset.target;
        const target = document.getElementById(targetId);
        if (!target) return;
        const saved = localStorage.getItem(storageKeyFor(targetId));
        if (saved === 'true'){ // collapsed
          target.style.display = 'none';
          bar.setAttribute('aria-expanded','false');
        } else if (saved === 'false'){ // expanded
          target.style.display = '';
          bar.setAttribute('aria-expanded','true');
        }
      });
    }
    function toggleSection(bar){
      const targetId = bar.dataset.target;
      const target = document.getElementById(targetId);
      if (!target) return;
      const willShow = target.style.display === 'none';
      target.style.display = willShow ? '' : 'none';
      bar.setAttribute('aria-expanded', willShow ? 'true' : 'false');
      try { localStorage.setItem(storageKeyFor(targetId), (!willShow).toString()); } catch {}
    }
    document.addEventListener('click', (e)=>{
      const bar = e.target.closest('.sectionbar');
      if (bar) toggleSection(bar);
    });
    document.addEventListener('keydown', (e)=>{
      const bar = e.target.closest('.sectionbar');
      if (!bar) return;
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSection(bar); }
    });

    // Fullscreen per card/box
    function toggleFullscreen(el){
      if (!document.fullscreenElement) el.requestFullscreen().catch(()=>{});
      else document.exitFullscreen().catch(()=>{});
    }
    document.addEventListener('click', (e)=>{
      const fs = e.target.closest('.fs-btn');
      if (fs) {
        const host = fs.closest('.box, .card');   // supports .box and .card
        if (host) toggleFullscreen(host);
      }
    });

    // Exit Fullscreen overlay (left) + focus on enter
    function ensureFsExitBtn(host){
      if (!host) return;
      if (host.querySelector('.fs-exit')) return;
      const btn = document.createElement('button');
      btn.className = 'fs-exit';
      btn.type = 'button';
      btn.setAttribute('aria-label', 'Exit fullscreen');
      btn.textContent = 'âœ• Exit Fullscreen';
      btn.addEventListener('click', ()=> document.exitFullscreen().catch(()=>{}));
      host.appendChild(btn);
      // Put keyboard focus on the exit button to give an immediate way out
      setTimeout(()=> btn.focus(), 0);
    }
    function removeFsExitBtns(){
      document.querySelectorAll('.fs-exit').forEach(b=> b.remove());
    }
    function syncFsButtons(){
      const isFS = !!document.fullscreenElement;
      document.querySelectorAll('.fs-btn').forEach(btn=>{
        btn.title = isFS ? 'Exit fullscreen (Esc)' : 'Fullscreen';
      });
      if (isFS) ensureFsExitBtn(document.fullscreenElement);
      else removeFsExitBtns();
    }
    document.addEventListener('fullscreenchange', syncFsButtons);

    // Grafana URL normalization (preserves your defaults; forces kiosk&fullscreen)
    function normalizeGrafanaUrl(src, desiredTheme){
      try{
        const u = new URL(src);
        if (!u.searchParams.get('orgId')) u.searchParams.set('orgId','2');
        if (!u.searchParams.get('timezone')) u.searchParams.set('timezone','browser');
        u.searchParams.set('theme', desiredTheme);
        let s = u.toString();
        s = s.replace(/([?&])kiosk(=[^&]*)?/g, '$1')
             .replace(/([?&])fullscreen(=[^&]*)?/g, '$1')
             .replace(/[?&]{2,}/g, m => m[0]);
        s += (s.includes('?') ? '&' : '?') + 'kiosk&fullscreen';
        return s;
      }catch(e){ return src; }
    }
    function normalizeAllIframes(themeMode){
      document.querySelectorAll('iframe').forEach(f=>{
        const next = normalizeGrafanaUrl(f.src, themeMode);
        if (next !== f.src) f.src = next;
      });
    }

    // Iframe fallback overlay if load stalls (simple error message; no actions)
    function attachIframeFallback(iframe, timeoutMs = 9000){
      if (!iframe) return;
      let done = false;
      const frameWrap = iframe.parentElement; // .frame or .card-body
      let overlay = null;

      const showOverlay = () => {
        if (done || overlay) return;
        overlay = document.createElement('div');
        overlay.className = 'iframe-fallback';
        const msg = document.createElement('div');
        msg.className = 'msg';
        msg.textContent = 'Error loading panel. Please try again later.';
        overlay.appendChild(msg);
        frameWrap.appendChild(overlay);
      };

      const t = setTimeout(showOverlay, timeoutMs);

      iframe.addEventListener('load', () => {
        done = true;
        clearTimeout(t);
        overlay?.remove();
      }, { once: true });
    }

    
    // Enhance Fullscreen buttons for consistent mobile rendering (replace glyph with SVG)
    function enhanceFsButtons() {
      document.querySelectorAll('.fs-btn').forEach(btn => {
        // Keep title updates from existing logic; just ensure accessible label
        if (!btn.getAttribute('aria-label')) btn.setAttribute('aria-label', 'Fullscreen');
        // Avoid double-initialization
        if (btn.dataset.enhanced === '1') return;
        btn.dataset.enhanced = '1';
        // Replace inner content with an SVG icon + screen-reader-only text
        btn.innerHTML = `<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" aria-hidden=\"true\">
  <path d=\"M4 9V4h5M20 9V4h-5M4 15v5h5M20 15v5h-5\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>
</svg><span class="sr-only">Fullscreen</span>`;
      });
    }

    // Theme handling
    const themeBtn = document.getElementById('themeToggle');
    function applyTheme(mode){
      document.body.classList.toggle('light', mode === 'light');
      themeBtn.textContent = mode === 'light' ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
      normalizeAllIframes(mode);
      try { localStorage.setItem('ws_theme', mode); } catch {}
    }
    (function initTheme(){
      let mode = 'dark';
      try {
        const saved = localStorage.getItem('ws_theme');
        if (saved === 'light' || saved === 'dark') mode = saved;
        else if (window.matchMedia && matchMedia('(prefers-color-scheme: light)').matches) mode = 'light';
      } catch {}
      applyTheme(mode);
    })();
    themeBtn.addEventListener('click', ()=>{
      const next = document.body.classList.contains('light') ? 'dark' : 'light';
      applyTheme(next);
    });

    // Initialize: restore section states and attach iframe fallbacks
    restoreSectionState();
    document.querySelectorAll('iframe').forEach(f => attachIframeFallback(f));
    enhanceFsButtons();
  </script>
</body>
</html>
