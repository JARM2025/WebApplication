<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Weather Station — Dashboards & Summary</title>

  <!-- Inter to match Grafana -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root { --bg:#0b0f19; --fg:#e6e9ef; --card:#111727; --border:rgba(255,255,255,.12); }
    body.light { --bg:#f7f8fb; --fg:#0b0f1d; --card:#ffffff; --border:rgba(0,0,0,.15); }

    *{ box-sizing:border-box }
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Header + tabs */
    header{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      padding:12px 16px; background:var(--card); border-bottom:1px solid var(--border);
      box-shadow:0 2px 6px rgba(0,0,0,.2);
    }
    header h1{ margin:0; font-size:18px; font-weight:700; }
    .spacer{ flex:1 1 auto }
    .tabs{
      display:inline-flex; gap:6px; padding:4px; border:1px solid var(--border);
      border-radius:12px; background:rgba(255,255,255,.02);
    }
    .tab{
      appearance:none; border:0; background:transparent; color:var(--fg);
      padding:6px 12px; border-radius:8px; font:600 13px "Inter",system-ui,sans-serif; cursor:pointer;
    }
    .tab[aria-selected="true"]{ background:rgba(255,255,255,.08); }
    .theme-btn{
      appearance:none; border:1px solid var(--border); background:transparent; color:var(--fg);
      border-radius:10px; padding:6px 12px; font:600 13px "Inter",system-ui,sans-serif; cursor:pointer;
      height:32px;
    }
    .theme-btn:hover{ border-color:rgba(100,100,100,.4) }

    .wrap{ width:100%; padding:8px 0; }

    /* Section bars (Dashboards) */
    .sectionbar{
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:8px;
      padding:12px 12px 8px; border-bottom:1px solid var(--border); background:var(--card); margin-bottom:4px;
      cursor:pointer; user-select:none; transition: background .15s ease, color .15s ease;
    }
    .sectionbar:hover{ background:rgba(255,255,255,.04); }
    .sectionbar h2{ margin:0; font:700 18px "Inter",system-ui,sans-serif; text-align:center; position:relative; }
    .sectionbar h2::after{ content:"▾"; font-size:14px; margin-left:10px; opacity:.6; }
    .sectionbar[aria-expanded="false"] h2::after{ content:"▸"; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; padding:0 12px; }
    .col{ flex:1; min-width:300px; }

    .box{
      margin:12px 0; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--card);
      height:70vh; box-shadow:0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.3);
    }
    .box-head{
      display:flex; align-items:center; justify-content:space-between;
      height:36px; padding:6px 10px; border-bottom:1px solid var(--border); background:rgba(0,0,0,.08);
    }
    .box-head .title{ font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .fs-btn{
      border:1px solid var(--border); background:transparent; color:var(--fg);
      border-radius:8px; padding:4px 8px; font:600 12px "Inter",system-ui,sans-serif; cursor:pointer;
    }
    .fs-btn:hover{ border-color:rgba(100,100,100,.4) }
    .frame{ height:calc(70vh - 36px); }
    iframe{ width:100%; height:100%; border:0; display:block; }

    .box:fullscreen{ border:none; border-radius:0; height:100vh; background:var(--card); }
    .box:fullscreen .box-head{ display:none; }
    .box:fullscreen .frame{ height:100vh; }

    /* Summary cards */
    .summary-grid{
      display:grid; gap:16px; padding:0 12px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }
    .card{
      border:1px solid var(--border); background:var(--card); border-radius:14px;
      box-shadow:0 1px 0 rgba(255,255,255,.03), 0 6px 18px rgba(0,0,0,.3);
      overflow:hidden; min-height:160px; display:flex; flex-direction:column;
    }
    .card-head{ padding:10px 12px; font-weight:600; border-bottom:1px solid var(--border); opacity:.9; }
    .card-body{ height:220px; }
    @media (min-width: 1200px){ .card-body{ height:240px; } }

    /* Hide non-selected tab panels */
    [role="tabpanel"]{ display:none; }
    [role="tabpanel"][data-active="true"]{ display:block; }
  </style>
</head>
<body>
  <header>
    <h1>Weather Station</h1>
    <div class="spacer"></div>
    <div class="tabs" role="tablist" aria-label="Views">
      <button class="tab" role="tab" id="tab-dash" aria-controls="panel-dash" aria-selected="true">Dashboards</button>
      <button class="tab" role="tab" id="tab-summary" aria-controls="panel-summary" aria-selected="false">Summary</button>
    </div>
    <button id="themeToggle" class="theme-btn">🌙 Dark Mode</button>
  </header>

  <main class="wrap">
    <!-- ================= Dashboards panel ================= -->
    <section id="panel-dash" role="tabpanel" aria-labelledby="tab-dash" data-active="true">
      <!-- F Index -->
      <div class="sectionbar" data-target="sec-findex" aria-controls="sec-findex" aria-expanded="true" title="Click to show/hide">
        <div></div><h2>F Index</h2><div></div>
      </div>
      <div id="sec-findex" class="row">
        <div class="col">
          <div class="box">
            <div class="box-head">
              <span class="title">F Index — Last Value</span>
              <button class="fs-btn" title="Fullscreen">⤢</button>
            </div>
            <div class="frame">
              <iframe src="https://grafana.weatherstation.site/d/aexavp9st0d8gf/f-index-values?orgId=2&theme=dark&from=now-5m&to=now&timezone=browser&refresh=5s&viewPanel=1" allowfullscreen></iframe>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="box">
            <div class="box-head">
              <span class="title">F Index — Historical Data</span>
              <button class="fs-btn" title="Fullscreen">⤢</button>
            </div>
            <div class="frame">
              <iframe src="https://grafana.weatherstation.site/d/eexavbf1ivqwwb/f-index-data?orgId=2&theme=dark&from=now-5m&to=now%2B5m&timezone=browser&refresh=5s&viewPanel=1" allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </div>

      <!-- Sensor 1 (DHT22) -->
      <div class="sectionbar" data-target="sec-s1" aria-controls="sec-s1" aria-expanded="true" title="Click to show/hide">
        <div></div><h2>Sensor 1 (DHT22)</h2><div></div>
      </div>
      <div id="sec-s1" class="row">
        <div class="col">
          <div class="box">
            <div class="box-head">
              <span class="title">Sensor 1 — Last Value</span>
              <button class="fs-btn" title="Fullscreen">⤢</button>
            </div>
            <div class="frame">
              <iframe src="https://grafana.weatherstation.site/d/cewx3uhpyrsowa/dht22-1-values?orgId=2&theme=dark&from=now-5m&to=now&timezone=browser&refresh=5s&viewPanel=1" allowfullscreen></iframe>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="box">
            <div class="box-head">
              <span class="title">Sensor 1 — Historical Data</span>
              <button class="fs-btn" title="Fullscreen">⤢</button>
            </div>
            <div class="frame">
              <iframe src="https://grafana.weatherstation.site/d/aewvz2fwevpc0c/dht22-1-data?orgId=2&theme=dark&from=now-5m&to=now%2B5m&timezone=browser&refresh=5s&viewPanel=1" allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </div>

      <!-- Sensor 2 (Anemometer) -->
      <div class="sectionbar" data-target="sec-s2" aria-controls="sec-s2" aria-expanded="true" title="Click to show/hide">
        <div></div><h2>Sensor 2 (Anemometer)</h2><div></div>
      </div>
      <div id="sec-s2" class="row">
        <div class="col">
          <div class="box">
            <div class="box-head">
              <span class="title">Sensor 2 — Last Value</span>
              <button class="fs-btn" title="Fullscreen">⤢</button>
            </div>
            <div class="frame">
              <iframe src="https://grafana.weatherstation.site/d/dexaqaus59w5ca/anemometer-values?orgId=2&theme=dark&from=now-5m&to=now&timezone=browser&refresh=5s&viewPanel=1" allowfullscreen></iframe>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="box">
            <div class="box-head">
              <span class="title">Sensor 2 — Historical Data</span>
              <button class="fs-btn" title="Fullscreen">⤢</button>
            </div>
            <div class="frame">
              <iframe src="https://grafana.weatherstation.site/d/dexan9rr3s3k0b/anemometer-data?orgId=2&theme=dark&from=now-5m&to=now%2B5m&timezone=browser&refresh=5s&viewPanel=1" allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ================= Summary panel ================= -->
    <section id="panel-summary" role="tabpanel" aria-labelledby="tab-summary" data-active="false">
      <div class="summary-grid">
        <section class="card">
          <div class="card-head">F Index — Last Value</div>
          <div class="card-body">
            <iframe src="https://grafana.weatherstation.site/d/aexavp9st0d8gf/f-index-values?orgId=2&theme=dark&from=now-10m&to=now&timezone=browser&refresh=10s&viewPanel=1" allowfullscreen></iframe>
          </div>
        </section>

        <section class="card">
          <div class="card-head">DHT22 — Last Values</div>
          <div class="card-body">
            <iframe src="https://grafana.weatherstation.site/d/cewx3uhpyrsowa/dht22-1-values?orgId=2&theme=dark&from=now-10m&to=now&timezone=browser&refresh=10s&viewPanel=1" allowfullscreen></iframe>
          </div>
        </section>

        <section class="card">
          <div class="card-head">Anemometer — Last Value</div>
          <div class="card-body">
            <iframe src="https://grafana.weatherstation.site/d/dexaqaus59w5ca/anemometer-values?orgId=2&theme=dark&from=now-10m&to=now&timezone=browser&refresh=10s&viewPanel=1" allowfullscreen></iframe>
          </div>
        </section>

        <section class="card">
          <div class="card-head">System Status (optional)</div>
          <div class="card-body">
            <!-- Point this to a simple stat panel if/when you create it -->
            <iframe src="https://grafana.weatherstation.site/d/eexavbf1ivqwwb/f-index-data?orgId=2&theme=dark&from=now-10m&to=now&timezone=browser&refresh=10s&viewPanel=1" allowfullscreen></iframe>
          </div>
        </section>
      </div>
    </section>
  </main>

  <script>
    // ---------- Tabs ----------
    const tabs = [...document.querySelectorAll('.tab')];
    const panels = {
      'tab-dash': document.getElementById('panel-dash'),
      'tab-summary': document.getElementById('panel-summary'),
    };
    function activateTab(tabId, pushHash=true){
      tabs.forEach(t=>{
        const selected = (t.id === tabId);
        t.setAttribute('aria-selected', selected ? 'true' : 'false');
      });
      Object.entries(panels).forEach(([id, panel])=>{
        panel.dataset.active = (id === tabId) ? 'true' : 'false';
      });
      if (pushHash) location.hash = tabId === 'tab-summary' ? '#summary' : '#dashboards';
    }
    document.addEventListener('click', (e)=>{
      const t = e.target.closest('.tab');
      if (t) activateTab(t.id);
    });
    // Deep-linking with hash (#summary / #dashboards)
    window.addEventListener('hashchange', ()=>{
      const h = location.hash.toLowerCase();
      if (h.includes('summary')) activateTab('tab-summary', false);
      else if (h.includes('dash')) activateTab('tab-dash', false);
    });
    (function initTabs(){
      const h = location.hash.toLowerCase();
      if (h.includes('summary')) activateTab('tab-summary', false);
      else activateTab('tab-dash', false);
    })();

    // ---------- Collapsible sections (Dashboards) ----------
    document.addEventListener('click', (e)=>{
      const bar = e.target.closest('.sectionbar');
      if (bar) {
        const target = document.getElementById(bar.dataset.target);
        if (!target) return;
        const willShow = target.style.display === 'none';
        target.style.display = willShow ? '' : 'none';
        bar.setAttribute('aria-expanded', willShow ? 'true' : 'false');
      }
    });

    // ---------- Fullscreen per box ----------
    function toggleFullscreen(box){
      if (!document.fullscreenElement) box.requestFullscreen().catch(()=>{});
      else document.exitFullscreen().catch(()=>{});
    }
    document.addEventListener('click', (e)=>{
      const fs = e.target.closest('.fs-btn');
      if (fs) {
        const box = fs.closest('.box');
        if (box) toggleFullscreen(box);
      }
    });
    function syncFsButtons(){
      const isFS = !!document.fullscreenElement;
      document.querySelectorAll('.fs-btn').forEach(btn=>{
        btn.title = isFS ? 'Exit fullscreen (Esc)' : 'Fullscreen';
      });
    }
    document.addEventListener('fullscreenchange', syncFsButtons);

    // ---------- Grafana URL normalization ----------
    function normalizeGrafanaUrl(src, desiredTheme){
      try{
        const u = new URL(src);
        if (!u.searchParams.get('orgId')) u.searchParams.set('orgId','2');
        if (!u.searchParams.get('timezone')) u.searchParams.set('timezone','browser');
        u.searchParams.set('theme', desiredTheme);
        let s = u.toString();
        s = s.replace(/([?&])kiosk(=[^&]*)?/g, '$1')
             .replace(/([?&])fullscreen(=[^&]*)?/g, '$1')
             .replace(/[?&]{2,}/g, m => m[0]);
        s += (s.includes('?') ? '&' : '?') + 'kiosk&fullscreen';
        return s;
      }catch(e){ return src; }
    }
    function normalizeAllIframes(themeMode){
      document.querySelectorAll('iframe').forEach(f=>{
        const next = normalizeGrafanaUrl(f.src, themeMode);
        if (next !== f.src) f.src = next;
      });
    }

    // ---------- Theme handling ----------
    const themeBtn = document.getElementById('themeToggle');
    function applyTheme(mode){
      document.body.classList.toggle('light', mode === 'light');
      themeBtn.textContent = mode === 'light' ? '☀️ Light Mode' : '🌙 Dark Mode';
      normalizeAllIframes(mode);
      try { localStorage.setItem('ws_theme', mode); } catch {}
    }
    (function initTheme(){
      let mode = 'dark';
      try {
        const saved = localStorage.getItem('ws_theme');
        if (saved === 'light' || saved === 'dark') mode = saved;
      } catch {}
      applyTheme(mode);
    })();
    themeBtn.addEventListener('click', ()=>{
      const next = document.body.classList.contains('light') ? 'dark' : 'light';
      applyTheme(next);
    });
  </script>
</body>
</html>
